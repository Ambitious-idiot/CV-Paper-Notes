# Image Style Transfer Using CNNs笔记

## 一、背景

过去的风格迁移方法中缺少对图片语义的显式表示，只能提取低层次的纹理信息，无法将风格与内容进行分离。而CNN可以显式地提取图片的高层次信息用于提取风格和内容。这样就可以使用CNN提取出提供内容的目标图片的内容与提供风格的源图片的风格并加以融合。

## 二、基本思路

对于输入的提供内容的目标图片p，提供风格的源图片a和白噪声x，首先使用CNN（论文中使用VGG19）提取目标图片、源图片、白噪声的各层产生的特征图。对于白噪声，将第$l$层的每一通道产生的输出拉平为一长为$M_l=h\times w$的向量，再将该层的$N_l$个通道的输出向量拼成一个$N_l\times M_l$矩阵$F^l$，同理对于目标图片和源图片，分别生成每一层的$P^l$、$A^l$，接下来选取合适的层根据特征图生成的矩阵建立风格与内容两部分损失的加权和，利用梯度下降同时在白噪声上进行内容和风格的重建，最终由白噪声产生风格迁移的输出图片。

## 三、内容重建

通过VGG19 可以获得图片的多层次的特征信息，利用这些信息可以对图片内容进行重建。由于低层的特征图信息过于完整细致，利用它们做出的内容重建会发生逐个像素的还原，并没有真正意义地提取出内容而只能得到风格简单渲染的结果。而高层次的特征图信息则更有利于提取出内容以进行重建。因此使用高层的特征图进行内容重建。论文中使用$conv4\_2$层进行重建。

内容重建考虑直接使用两图片在$conv4\_2$层产生输出的MSE，即
$$
L_{content}(p,x,l)=\frac{1}{2}\sum_{i,j}(F^l_{ij}-P^l_{ij})^2
$$

## 四、风格重建

使用CNN某层各通道的输出可以建立特征空间，在特征空间中包含了各通道之间的相关性，使用Gram矩阵表示该特征空间：$G^l=[F^l_i\cdot F^l_j]$。白噪声x的Gram矩阵记作$G^l$，源图片a的Gram矩阵记作$A^l$。论文中认为对应多个层的输出进行风格重建会得到更加连续的视感，因此采用多个层的加权平均。论文中使用$conv1\_1,\space conv2\_1,\space conv3\_1,\space conv4\_1, \space conv5\_1$

风格重建考虑使用各层上输出Gram矩阵的MSE加权和，即
$$
L_{style}(a,x)=
\sum_l({\frac{\omega_l}{4N_l^2M_l^2}\sum_{i,j}(G^l_{ij}-A^l_{ij})^2)}
$$

## 五、风格迁移

总损失函数为内容重建损失与风格重建损失的加权和，即
$$
L_{total}(p,a,x)=\alpha L_{content}(p,x)+\beta L_{style}(a,x)
$$

## 六、实现细节

使用L-BFGS进行优化。

需要注意内容与风格之间的tradeoff。

内容重建使用conv5，风格重建使用conv1-conv5。

也可以用于实景的风格迁移（如夜景迁移至一张白天的照片）

## 七、缺陷

分辨率低。

低层次噪音影响大。

